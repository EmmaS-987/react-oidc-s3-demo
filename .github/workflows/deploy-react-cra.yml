name: SalsaGate (CRA deploy)

on:
  push:
    branches: [ "tamper_demo" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_DIR: build
  AWS_REGION: us-east-1
  S3_BUCKET: tamper-demo-react-app

jobs:
  build:
    name: Build & Stage (CRA)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (CRA)
        run: npm run build

      - name: Create integrity manifest (optional)
        run: |
          cd $BUILD_DIR
          find . -type f -print0 | sort -z | xargs -0 shasum -a 256 > ../checksums.sha256

      - name: Upload artifact (for record)
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: |
            ${{ env.BUILD_DIR }}/
            checksums.sha256
          if-no-files-found: error

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Stage the build to a per-run folder for optional manual edits
      - name: Stage build to S3 (pre-approval)
        run: |
          STAGING_PATH="_staging/${{ github.run_id }}/"
          DEST="s3://${{ env.S3_BUCKET }}/${STAGING_PATH}"
          echo "Staging to: $DEST"
          aws s3 sync "${{ env.BUILD_DIR }}/" "$DEST" --delete
          echo "✅ Build staged to $DEST"
          aws s3 ls "$DEST" --recursive

  approve_and_deploy:
    name: Manual Approval → Promote staging to site
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: demo
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    env:
      AWS_REGION: us-east-1
      S3_BUCKET: tamper-demo-react-app

    steps:
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Show staging location
        run: |
          echo "Staging path: _staging/${{ github.run_id }}/"
          echo "Staging URI:  s3://$S3_BUCKET/_staging/${{ github.run_id }}/"

      - name: List staged files
        run: |
          aws s3 ls "s3://$S3_BUCKET/_staging/${{ github.run_id }}/" --recursive || true

      # SAFE PROMOTION: dry-run + guardrail to ensure direction is STAGING -> ROOT
      - name: Promote staging → website root (safe)
        run: |
          set -euo pipefail

          STAGING_PATH="_staging/${{ github.run_id }}/"
          SRC="s3://$S3_BUCKET/${STAGING_PATH}"
          DST="s3://$S3_BUCKET/"

          echo "SOURCE (must be STAGING): $SRC"
          echo "DEST   (must be ROOT):    $DST"
          echo
          echo "Preview (dry-run):"
          aws s3 sync "$SRC" "$DST" --delete --exact-timestamps --dryrun || true
          echo

          # Abort if any planned delete touches _staging/ (indicates reversed args)
          if aws s3 sync "$SRC" "$DST" --delete --exact-timestamps --dryrun | grep -q '_staging/'; then
            echo "❌ Safety check failed: planned deletes under _staging/. Aborting."
            exit 1
          fi

          echo "Running real sync…"
          aws s3 sync "$SRC" "$DST" --delete --exact-timestamps
          echo "✅ Promotion complete. Live site:"
          echo "http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
