name: SalsaGate (CRA deploy)

on:
  push:
    branches: [ "tamper_demo" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_DIR: build
  AWS_REGION: us-east-1
  S3_BUCKET: tamper-demo-react-app

jobs:
  build:
    name: Build & Stage (CRA)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (CRA)
        run: npm run build

      - name: Create integrity manifest (optional)
        run: |
          cd $BUILD_DIR
          find . -type f -print0 | sort -z | xargs -0 shasum -a 256 > ../checksums.sha256

      - name: Upload artifact (for record)
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: |
            ${{ env.BUILD_DIR }}/
            checksums.sha256
          if-no-files-found: error

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Stage the build to a per-run folder
      - name: Stage build to S3 (pre-approval)
        run: |
          STAGING_PATH="_staging/${{ github.run_id }}/"
          DEST="s3://${{ env.S3_BUCKET }}/${STAGING_PATH}"
          echo "Staging to: $DEST"
          aws s3 sync "${{ env.BUILD_DIR }}/" "$DEST" --delete
          echo "✅ Build staged to $DEST"
          aws s3 ls "$DEST" --recursive

  approve_and_deploy:
    name: Manual Approval → Promote staging to site
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: demo
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    env:
      AWS_REGION: us-east-1
      S3_BUCKET: tamper-demo-react-app
      BUILD_DIR: build

    steps:
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Recompute the same staging path we used in build
      - name: Show staging location
        id: where
        run: |
          echo "STAGING_PATH=_staging/${{ github.run_id }}/" >> "$GITHUB_OUTPUT"
          echo "Staging path: _staging/${{ github.run_id }}/"
          echo "Staging URI:  s3://${{ env.S3_BUCKET }}/_staging/${{ github.run_id }}/"

      - name: List staged files
        run: |
          aws s3 ls "s3://$S3_BUCKET/${{ steps.where.outputs.STAGING_PATH }}" --recursive || true

      # If staging is empty (no files), repopulate from artifact so deploy still works.
      - name: Ensure staging has content (fallback to artifact if empty)
        run: |
          set -euo pipefail
          STAGING_URI="s3://$S3_BUCKET/${{ steps.where.outputs.STAGING_PATH }}"
          COUNT=$(aws s3 ls "$STAGING_URI" --recursive | wc -l | tr -d ' ')
          echo "Staging file count: $COUNT"
          if [ "$COUNT" -eq "0" ]; then
            echo "⚠️ Staging is empty. Falling back to build artifact."
            mkdir -p dl
            echo "Downloading artifact..."
            gh release -R "$GITHUB_REPOSITORY" >/dev/null 2>&1 || true
          fi
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # Safer artifact fallback: download the artifact and publish directly if staging is empty
      - name: Download artifact (for fallback)
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: dl

      - name: Promote to website root
        run: |
          set -euo pipefail
          STAGING_URI="s3://$S3_BUCKET/${{ steps.where.outputs.STAGING_PATH }}"
          COUNT=$(aws s3 ls "$STAGING_URI" --recursive | wc -l | tr -d ' ')
          if [ "$COUNT" -gt "0" ]; then
            echo "Promoting from STAGING → root"
            aws s3 sync "$STAGING_URI" "s3://$S3_BUCKET/" --delete
          else
            echo "Promoting from ARTIFACT → root (staging was empty)"
            aws s3 sync "dl/${{ env.BUILD_DIR }}" "s3://$S3_BUCKET/" --delete
          fi

          echo "✅ Promotion complete. Site now live:"
          echo "http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
